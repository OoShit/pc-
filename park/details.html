{extend name="base" /}
{block name="css"}
<style>
    .file-footer-buttons{display:none;}
</style>
<link href="__js__/fileinput/css/fileinput.min.css" rel="stylesheet">
<link href="__css__/bootstrap-switch.css" rel="stylesheet">
{/block}
{block name="content"}
<div id="page-wrapper" class="gray-bg dashbard-1">
    <div class="row gray-bg">
        <ol class="breadcrumb">
            <li><a href="#"><i class="fa fa-home"></i>平台管理</a></li>
            <li><a href="" class="active">园区详情</a></li>
        </ol>
    </div>
    <div class="row park-wrapper">
        <div class="park-head clearfix">
            <div class="park-detail">
                <h4 class="park-title">{$park.name}</h4>
                <p class="park-mContent"><span class="name-title">园区编号：</span>{$park.code}<span class="name-title">负责人：</span>{$park.charge_name}</p>
                <p class="park-mContent"><span class="name-title">园区邮箱：</span>{$park.email}</p>
                <p class="park-mContent"><span class="name-title">园区地址：</span>{$park.addr}</p>
                <p class="park-mContent"><span class="name-title">园区简介：</span>{$park.comment}</p>
            </div>
            <div class="park-img">
                <img src="{$park.url}">
            </div>
        </div>
        <div class="contain">
            <button class="btn btn-primary reset-position" data-toggle="modal" data-target="#addC">添加公司</button>
            <button class="btn btn-primary reset-position" data-toggle="modal" data-target="#addL">添加地块</button>
            {if condition='!empty($company) or !empty($park_land)'}
            <ul id="company-tab" class="nav nav-tabs">
                {if condition='!empty($park_land)'}
                <li class="active">
                    <a href="#pl" data-toggle="tab">园区直属地块</a>
                </li>
                {/if}
                {if condition='!empty($company)'}
                    {volist name='company' id='vo' key='k'}
                        {if condition='$k==1 && empty($park_land)'}
                        <li class="active">
                        {else/}
                        <li class="">
                        {/if}
                            <a href="#c{$vo.id}" data-toggle="tab" id="{$vo.id}">{$vo.name}<span class="badge" style="cursor:pointer" onclick="C_details(this,'{$vo.id}')">详情</span></a>
                        </li>
                    {/volist}
                {/if}
            </ul>
            <div id="company-tabContent" class="tab-content">
                {if condition='!empty($company)'}
                {volist name='company' id='vo' key='k'}
                    {if condition='$k==1 && empty($park_land)'}
                    <div id="c{$vo.id}" class="tab-pane fade in active">
                    {else/}
                    <div id="c{$vo.id}" class="tab-pane fade">
                    {/if}

                    {volist name='land' id='v'}
                        {php}
                        $a=0;
                        {/php}
                       {eq name='$v.company_id' value='$vo.id'}
                    <div class="ibox border-bottom">
                        <div class="ibox-title">
                            <h5 style="cursor:pointer" onclick="detail_L('{$v.id}')" onmouseover="this.style.color='blue'" onmouseout="this.style.color='black'">{$v.name}</h5>
                            <button class="btn btn-primary button-pill btn-sm" onclick="addE('{$v.id}','{$v.name}')">添加传感器</button>
                            <button class="btn btn-success button-pill btn-sm" onclick="editL('{$v.id}')">编辑地块</button>
                            <button class="btn btn-danger button-pill btn-sm" onclick="delcfm('{:url(\'admin/Land/del\',[\'id\' => $v[\'id\']])}','{$v.name}','及其下属所有传感器')">删除地块</button>
                            <div class="well well-sm">
                                {volist name='equip' id='val'}
                                    {eq name='$val.land_id' value='$v.id'}
                                        {php}
                                        $a++;
                                        {/php}
                                        {if condition='$a<9'}
                                        <img src="{$val.image}" class="senser-img" onmouseover="equipData(this,'{$val.name}')" style="cursor:pointer">
                                        {/if}
                                    {/eq}
                                {/volist}
                            </div>
                            <div class="ibox-tools">
                                <a class="collapse-link">
                                        查看详情
                                        <i class="fa fa-chevron-down"></i>
                                    </a>
                            </div>
                        </div>
                        <div class="ibox-content">
                            <table id="park-info" class="table table-striped table-hover">
                                <tbody class="reset-vertical">
                                {volist name='equip' id='val'}
                                    {eq name='$val.land_id' value='$v.id'}
                                    <tr>
                                        <td><img src="{$val.image}" class="senser-img">{$val.name_ch}</td>
                                        <td><span class="td-title">传感器编号：</span>{$val.code}</td>
                                        <td><span class="td-title">传感器名：</span>{$val.name}</td>
                                        <td><span class="td-title">状态：</span>
                                            <input type="checkbox" name="my-checkbox" value="{$val.id}" {eq name="$val.status" value="1"}checked {/eq}>
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-success  btn-sm" onclick="editE('{$val.id}','{$v.name}')">编辑</button>
                                            <button type="button" class="btn btn-danger btn-sm" onclick="delcfm('{:url(\'admin/Equip/del\',[\'id\' => $val[\'id\']])}','{$val.name}','传感器')">删除</button>
                                        </td>
                                    </tr>
                                {/eq}
                                {/volist}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {/eq}
                    {/volist}
                </div>
                {/volist}
                {/if}

                {if condition='!empty($park_land)'}
                <div id="pl"  class="tab-pane fade active in">

                    {volist name='park_land' id='v'}
                    {php}
                    $b=0;
                    {/php}
                    <div class="ibox border-bottom">
                        <div class="ibox-title">
                            <h5 style="cursor:pointer" onclick="detail_L('{$v.id}')" onmouseover="this.style.color='blue'" onmouseout="this.style.color='black'">{$v.name}</h5>
                            <button class="btn btn-primary button-pill btn-sm" onclick="addE('{$v.id}','{$v.name}')">添加传感器</button>
                            <button class="btn btn-success button-pill btn-sm" onclick="editL('{$v.id}')">编辑地块</button>
                            <button class="btn btn-danger button-pill btn-sm" onclick="delcfm('{:url(\'admin/Land/del\',[\'id\' => $v[\'id\']])}','{$v.name}','及其下属所有传感器')">删除地块</button>
                            <div class="well well-sm">
                                {volist name='equip' id='val'}
                                    {eq name='$val.land_id' value='$v.id'}
                                        {php}
                                        $b++;
                                        {/php}
                                        {if condition='$b<9'}
                                            <img src="{$val.image}" class="senser-img" onmouseover="equipData(this,'{$val.name}')" style="cursor:pointer">
                                        {/if}
                                    {/eq}
                                {/volist}
                            </div>
                            <div class="ibox-tools">
                                <a class="collapse-link">
                                    查看详情
                                    <i class="fa fa-chevron-down"></i>
                                </a>
                            </div>
                        </div>
                        <div class="ibox-content">
                            <table id="park-info" class="table table-striped table-hover">
                                <tbody class="reset-vertical">
                                {volist name='equip' id='val'}
                                {eq name='$val.land_id' value='$v.id'}
                                <tr>
                                    <td><img src="{$val.image}" class="senser-img">{$val.name_ch}</td>
                                    <td><span class="td-title">传感器编号：</span>{$val.code}</td>
                                    <td><span class="td-title">传感器名：</span>{$val.name}</td>
                                    <td><span class="td-title">状态：</span>
                                        <input type="checkbox" name="my-checkbox" value="{$val.id}" {eq name="$val.status" value="1"}checked {/eq}>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-success btn-sm" onclick="editE('{$val.id}','{$v.name}')">编辑</button>
                                        <button type="button" class="btn btn-danger btn-sm" onclick="delcfm('{:url(\'admin/Equip/del\',[\'id\' => $val[\'id\']])}','{$val.name}','传感器')">删除</button>
                                    </td>
                                </tr>
                                {/eq}
                                {/volist}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {/volist}

                </div>
              {/if}
            </div>

                </div>
            {/if}
        </div>


    </div>
    <!-- park-wrapper -->
</div>

<!-- 模态框（Modal） 添加公司-->
<div class="modal fade" id="addC" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">添加公司</h4>
            </div>

            <div class="modal-body">
                <form id="tform" class="form-horizontal form" enctype="multipart/form-data" role="form" name="form">

                    <div class="form-group" >
                        <label for="inputPassword"  class="col-sm-2 control-label">上级园区</label>
                        <div class="col-sm-10">
                            <input id="park_id" type="hidden" value="{$park.id}">
                            <input class="form-control"  type="text" value="{$park.name}" disabled>
                        </div>
                    </div>

                    <div class="form-group" >
                        <label for="inputPassword"  class="col-sm-2 control-label">公司名称</label>
                        <div class="col-sm-10">
                            <input class="form-control" minlength="2" required  id="a_name" type="text" placeholder="请输入公司名称" >
                        </div>
                    </div>


                    <div class="form-group">
                        <label for="inputPassword" class="col-sm-2 control-label">公司地址</label>
                        <div class="col-sm-10">
                            <input class="form-control" minlength="9"  required   id="a_addr" type="text" placeholder="请输入公司地址">
                        </div>
                    </div>

                    <div class="form-group" >
                        <label for="inputPassword"  class="col-sm-2 control-label">负责人</label>
                        <div class="col-sm-10">
                            <input class="form-control" minlength="2" required  id="a_charge_name" type="text" placeholder="请输入公司负责人姓名" >
                        </div>
                    </div>


                    <div class="form-group" >
                        <label for="inputPassword"  class="col-sm-2 control-label">公司电话</label>
                        <div class="col-sm-10">
                            <input class="form-control"  type="text" id="a_tel"  placeholder="请输入公司电话（手机号）">
                        </div>
                    </div>

                    <div class="form-group" >
                        <label for="inputPassword"  class="col-sm-2 control-label">公司照片</label>
                        <div class="col-sm-10">
                            <input type="hidden" id="a_url">
                            <input class="form-control file file-loading" name="image" type="file" id="a_image">
                            <p class="help-block">支持jpg、png、gif格式，多次上传保留最后一张</p>
                        </div>
                    </div>

                    <div class="form-group" >
                        <label for="inputPassword"  class="col-sm-2 control-label">公司简介</label>
                        <div class="col-sm-10">
                           <!-- <input class="form-control"  type="text" id="a_comment"  placeholder="备注信息可不填">-->
                            <textarea class="form-control" id="a_comment" rows="4" placeholder="请输入公司简介"></textarea>
                        </div>
                    </div>

            </div>
            <div class="modal-footer">
                <input name="res" type="reset" style="display:none;" />
                <button  type="button"  class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="submit btn btn-primary" onclick="addC()">确认添加</button>
            </div>
            </form>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>

<!-- 模态框（Modal） 公司详情展示-->
<div class="modal fade" id="detail_C" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">公司详情</h4>
            </div>
            <input type="hidden" id="company">
            <input type="hidden" id="company_name">
            <div class="modal-body">
                <table class="table table-bordered" >
                    <tbody id="C_details">

                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <input name="res" type="reset" style="display:none;" />
                <button  type="button"  class="btn btn-default" data-dismiss="modal">关闭</button>
                <button  type="button"  class="btn btn-success" onclick="editC()">编辑</button>
                <button  type="button"  class="btn btn-danger" onclick="delC()">删除</button>
            </div>

        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>

<!-- 模态框（Modal） 更新公司-->
<div class="modal fade" id="updateC" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">编辑公司</h4>
            </div>

            <div class="modal-body">
                <form id="tform" class="form-horizontal form" role="form" name="form">

                    <div class="form-group" >
                        <label for="inputPassword"  class="col-sm-2 control-label">上级园区</label>
                        <div class="col-sm-10">
                            <input id="company_id" type="hidden">
                            <input class="form-control"  type="text" value="{$park.name}" disabled>
                        </div>
                    </div>

                    <div class="form-group" >
                        <label for="inputPassword"  class="col-sm-2 control-label">公司名称</label>
                        <div class="col-sm-10">
                            <input class="form-control" minlength="2" required  id="u_name" type="text" placeholder="请输入公司名称" >
                        </div>
                    </div>


                    <div class="form-group">
                        <label for="inputPassword" class="col-sm-2 control-label">公司地址</label>
                        <div class="col-sm-10">
                            <input class="form-control" minlength="9"  required   id="u_addr" type="text" placeholder="请输入公司地址">
                        </div>
                    </div>

                    <div class="form-group" >
                        <label for="inputPassword"  class="col-sm-2 control-label">负责人</label>
                        <div class="col-sm-10">
                            <input class="form-control" minlength="2" required  id="u_charge_name" type="text" placeholder="请输入公司负责人姓名" >
                        </div>
                    </div>


                    <div class="form-group" >
                        <label for="inputPassword"  class="col-sm-2 control-label">公司电话</label>
                        <div class="col-sm-10">
                            <input class="form-control"  type="text" id="u_tel"  placeholder="请输入公司电话（手机号）">
                        </div>
                    </div>

                    <div class="form-group" >
                        <label for="inputPassword"  class="col-sm-2 control-label">公司照片</label>
                        <div class="col-sm-10">
                            <img src="" width="100%" id="img">
                            <input type="hidden" id="u_url">
                            <input class="form-control file file-loading" name="image" type="file" id="u_image">
                            <p class="help-block">支持jpg、png、gif格式，多次上传保留最后一张</p>
                        </div>
                    </div>

                    <div class="form-group" >
                        <label for="inputPassword"  class="col-sm-2 control-label">公司简介</label>
                        <div class="col-sm-10">
                            <!-- <input class="form-control"  type="text" id="a_comment"  placeholder="备注信息可不填">-->
                            <textarea class="form-control" id="u_comment" rows="4" placeholder="请输入公司简介"></textarea>
                        </div>
                    </div>

            </div>
            <div class="modal-footer">
                <input name="res" type="reset" style="display:none;" />
                <button  type="button"  class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="submit btn btn-primary" onclick="updataC()">确认编辑</button>
            </div>
            </form>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>

<!-- 模态框（Modal） 添加地块-->
<div class="modal fade" id="addL" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">添加地块</h4>
            </div>

            <div class="modal-body">
                <form id="tform" class="form-horizontal form" enctype="multipart/form-data" role="form" name="form">

                    <div class="form-group" >
                        <label for="inputPassword"  class="col-sm-2 control-label">上级部门</label>
                        <div class="col-sm-10">
                            <select class="form-control" id="a_upper">
                                <option value="0">{$park.name}</option>
                                {volist name='company' id='vo'}
                                <option value="{$vo.id}">|--{$vo.name}</option>
                                {/volist}
                            </select>
                        </div>
                    </div>

                    <div class="form-group" >
                        <label for="inputPassword"  class="col-sm-2 control-label">地块名称</label>
                        <div class="col-sm-10">
                            <input class="form-control" minlength="2" required  id="a_land_name" type="text" placeholder="请输入地块名称" >
                        </div>
                    </div>

                    <div class="form-group" >
                        <label for="inputPassword"  class="col-sm-2 control-label">地块面积</label>
                        <div class="col-sm-10">
                            <input class="form-control" minlength="2" required  id="a_land_acreage" type="text" placeholder="请输入地块面积(单位 ㎡)" >
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="inputPassword" class="col-sm-2 control-label">负责人</label>
                        <div class="col-sm-10">
                            <input class="form-control"   required   id="a_land_charge_name" type="text" placeholder="请输入地块负责人">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="inputPassword" class="col-sm-2 control-label">手机</label>
                        <div class="col-sm-10">
                            <input class="form-control"   required   id="a_land_tel" type="text" placeholder="请输入手机号">
                        </div>
                    </div>

                    <div class="form-group" >
                        <label for="inputPassword"  class="col-sm-2 control-label">地块简介</label>
                        <div class="col-sm-10">
                            <!-- <input class="form-control"  type="text" id="a_comment"  placeholder="备注信息可不填">-->
                            <textarea class="form-control" id="a_land_comment" rows="4" placeholder="请输入地块简介"></textarea>
                        </div>
                    </div>

            </div>
            <div class="modal-footer">
                <input name="res" type="reset" style="display:none;" />
                <button  type="button"  class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="submit btn btn-primary" onclick="addL('{$park.id}')">确认添加</button>
            </div>
            </form>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>

<!-- 模态框（Modal） 编辑地块-->
<div class="modal fade" id="updateL" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">编辑地块</h4>
            </div>

            <div class="modal-body">
                <form id="tform" class="form-horizontal form" enctype="multipart/form-data" role="form" name="form">

                    <div class="form-group" >
                        <label for="inputPassword"  class="col-sm-2 control-label">上级部门</label>
                        <input type="hidden" id="land_id">
                        <div class="col-sm-10">
                            <select class="form-control" id="u_upper">
                                <option value="0">{$park.name}</option>
                                {volist name='company' id='vo'}
                                <option value="{$vo.id}">|--{$vo.name}</option>
                                {/volist}
                            </select>
                        </div>
                    </div>

                    <div class="form-group" >
                        <label for="inputPassword"  class="col-sm-2 control-label">地块名称</label>
                        <div class="col-sm-10">
                            <input class="form-control" minlength="2" required  id="u_land_name" type="text" placeholder="请输入地块名称" >
                        </div>
                    </div>

                    <div class="form-group" >
                        <label for="inputPassword"  class="col-sm-2 control-label">地块面积</label>
                        <div class="col-sm-10">
                            <input class="form-control" minlength="2" required  id="u_land_acreage" type="text" placeholder="请输入地块面积(单位 ㎡)" >
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="inputPassword" class="col-sm-2 control-label">负责人</label>
                        <div class="col-sm-10">
                            <input class="form-control"   required   id="u_land_charge_name" type="text" placeholder="请输入地块负责人">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="inputPassword" class="col-sm-2 control-label">手机</label>
                        <div class="col-sm-10">
                            <input class="form-control"   required   id="u_land_tel" type="text" placeholder="请输入手机号">
                        </div>
                    </div>

                    <div class="form-group" >
                        <label for="inputPassword"  class="col-sm-2 control-label">地块简介</label>
                        <div class="col-sm-10">
                            <!-- <input class="form-control"  type="text" id="a_comment"  placeholder="备注信息可不填">-->
                            <textarea class="form-control" id="u_land_comment" rows="4" placeholder="请输入地块简介"></textarea>
                        </div>
                    </div>

            </div>
            <div class="modal-footer">
                <input name="res" type="reset" style="display:none;" />
                <button  type="button"  class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="submit btn btn-primary" onclick="updateL('{$park.id}')">确认编辑</button>
            </div>
            </form>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>

<!-- 模态框（Modal） 地块详情展示-->
<div class="modal fade" id="detail_L" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">地块详情</h4>
            </div>

            <div class="modal-body">
                <table class="table table-bordered" >
                    <tbody id="details">

                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <input name="res" type="reset" style="display:none;" />
                <button  type="button"  class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>

        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>

<!-- 模态框（Modal） 添加传感器-->
<div class="modal fade" id="addE" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">添加传感器</h4>
            </div>

            <div class="modal-body">
                <form id="tform" class="form-horizontal form" enctype="multipart/form-data" role="form" name="form">

                    <div class="form-group" >
                        <label for="inputPassword"  class="col-sm-2 control-label">上级地块</label>
                        <div class="col-sm-10">
                            <input type="hidden" id="a_upper_land_id">
                            <input class="form-control" id="a_upper_land_name" type="text" disabled>
                        </div>
                    </div>

                    <div class="form-group" >
                        <label for="inputPassword"  class="col-sm-2 control-label">类型</label>
                        <div class="col-sm-10">
                            <select class="form-control" id="a_equiptype">
                                <option value="">--请选择传感器类型--</option>
                                {volist name='equiptype' id='vo'}
                                <option value="{$vo.id}">{$vo.name_ch}</option>
                                {/volist}
                            </select>
                        </div>
                    </div>

                    <div class="form-group" >
                        <label for="inputPassword"  class="col-sm-2 control-label">传感器名</label>
                        <div class="col-sm-10">
                            <input class="form-control" minlength="2" required  id="a_equip_name" type="text" placeholder="请输入传感器名称" >
                        </div>
                    </div>

                    <div class="form-group" >
                        <label for="inputPassword"  class="col-sm-2 control-label">监控设备</label>
                        <div class="col-sm-10">
                            <select class="form-control" id="a_camera_id">
                                <option value="0">--请选择监控设备(可不选)--</option>
                            </select>
                        </div>
                    </div>

            </div>
            <div class="modal-footer">
                <input name="res" type="reset" style="display:none;" />
                <button  type="button"  class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="submit btn btn-primary" onclick="saveE()">确认添加</button>
            </div>
            </form>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>

<!-- 模态框（Modal） 编辑传感器-->
<div class="modal fade" id="updateE" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">编辑传感器</h4>
            </div>

            <div class="modal-body">
                <form id="tform" class="form-horizontal form" enctype="multipart/form-data" role="form" name="form">

                    <div class="form-group" >
                        <label for="inputPassword"  class="col-sm-2 control-label">上级地块</label>
                        <div class="col-sm-10">
                            <input type="hidden" id="e_id">
                            <input class="form-control" id="u_upper_land_name" type="text" disabled>
                        </div>
                    </div>

                    <div class="form-group" >
                        <label for="inputPassword"  class="col-sm-2 control-label">类型</label>
                        <div class="col-sm-10">
                            <select class="form-control" id="u_equiptype">
                                <option value="0">--请选择传感器类型--</option>
                                {volist name='equiptype' id='vo'}
                                <option value="{$vo.id}">{$vo.name_ch}</option>
                                {/volist}
                            </select>
                        </div>
                    </div>

                    <div class="form-group" >
                        <label for="inputPassword"  class="col-sm-2 control-label">传感器名</label>
                        <div class="col-sm-10">
                            <input class="form-control" minlength="2" required  id="u_equip_name" type="text" placeholder="请输入传感器名称" >
                        </div>
                    </div>

                    <div class="form-group" >
                        <label for="inputPassword"  class="col-sm-2 control-label">监控设备</label>
                        <div class="col-sm-10">
                            <select class="form-control" id="u_camera_id">
                                <option value="0">--请选择监控设备(可不选)--</option>
                            </select>
                        </div>
                    </div>

            </div>
            <div class="modal-footer">
                <input name="res" type="reset" style="display:none;" />
                <button  type="button"  class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="submit btn btn-primary" onclick="updateE()">确认编辑</button>
            </div>
            </form>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>

<!-- 信息删除确认 -->
<div class="modal fade" id="delcfmModel">
    <div class="modal-dialog">
        <div class="modal-content message_align">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                <h4 class="modal-title">提示信息</h4>
            </div>
            <div class="modal-body">
                <p id="tishi" style="align-content: center; font-size: 20px">您确认要删除吗？</p>
            </div>
            <div class="modal-footer">
                <input type="hidden" id="url"/>
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <a  onclick="urlSubmit()" class="btn btn-success" data-dismiss="modal">确定</a>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
{/block}


{block name="script"}
<script src="__js__/fileinput/js/fileinput.min.js"></script>
<script src="__js__/fileinput/js/locales/zh.js"></script>
<script src="__js__/bootstrap-switch.js"></script>
<script src="__js__/jquery.cookie.js"></script>
<script>
    //刷新后恢复页面状态
    if("undefined" != typeof $.cookie('company')){
        var y = $.cookie('company');
        if(y != '#p1'){
            $("div[class^='tab-pane']").attr('class', 'tab-pane fade');
            $('#' + y.substr(2) + '').parent('li').parent('ul').children('li').attr('class', '');
            $('#' + y.substr(2) + '').parent('li').attr('class', 'active');
            $('#' + y.substr(1) + '').attr('class', 'tab-pane fade in active');
        }
        $.cookie('company','', { expires: -1 });
    }
    //添加公司
    function addC(){
        var park_id = $('#park_id').val();
        var name = $('#a_name').val();
        var addr = $('#a_addr').val();
        var charge_name = $('#a_charge_name').val();
        var tel = $('#a_tel').val();
        var url = $('#a_url').val();
        var comment = $('#a_comment').val();
        $.ajax({
            url: "{:url('admin/Company/addC')}",
            type: 'post',
            dataType: 'json',
            data: {park_id: park_id,name: name,addr: addr,charge_name: charge_name,tel: tel,url: url,comment: comment},
            success:function(data){
                console.log(data);
                if(data.code==0){
                    layer.msg(data.msg, {
                        icon: 2,
                        time: 2000
                    })
                }else{
                    var a = $('#company-tab .active');
                    var x = a.children('a').attr('href');
                    $.cookie('company',x);
                    $('#addC').modal('hide');
                    layer.msg(data.msg, {
                        icon: 1,
                        time: 2000
                    },function(){
                        location.reload();
                    })
                }
            }
        });
    }
    //公司详情
    function C_details(obj,id){
        var par = $(obj).parents('li');
        if(!par.hasClass('active')){
            return;
        }
        $.ajax({
            url: "{:url('admin/Company/companyDetail')}",
            type: 'post',
            dataType: 'json',
            data: {id: id},
            success:function(data){
                $('#company').val(data.id);
                $('#company_name').val(data.name);
                var tr = "<tr> <th>公司名称</th> <td  width='350'>"+data.name+"</td></tr> <tr> <th>公司编号</th> <td>"+data.code+"</td> </tr> <tr> <th>上级园区</th> <td>{$park.name}</td> </tr> <tr> <tr> <th>地址</th> <td>"+data.addr+"</td> </tr> <th>负责人</th> <td>"+data.charge_name+"</td> </tr> <tr> <th>手机号码</th> <td>"+data.tel+"</td> </tr> <tr> <th>公司简介</th> <td>"+data.comment+"</td> </tr> <tr><td colspan='2'><img src='"+data.url+"' width='100%'/></td> </tr>";
                $('#C_details').html(tr);
            }
        });
        $('#detail_C').modal('show');
    }
    //编辑公司
    function editC(){
        var id = $('#company').val();
        $('#company_id').val(id);
        $.ajax({
            url: "{:url('admin/Company/companyDetail')}",
            type: 'post',
            dataType: 'json',
            data: {id: id},
            success:function(data){
                $('#u_name').val(data.name);
                $('#u_addr').val(data.addr);
                $('#u_charge_name').val(data.charge_name);
                $('#u_tel').val(data.tel);
                $('#u_url').val(data.url);
                $('#u_comment').val(data.comment);
                $('#img').attr('src',data.url);
            }
        });
        //$('#detail_C').modal('hide');
        $('#updateC').modal('show');
    }
    function updataC(){
        var id = $('#company_id').val();
        var name = $('#u_name').val();
        var addr = $('#u_addr').val();
        var charge_name = $('#u_charge_name').val();
        var tel = $('#u_tel').val();
        var url = $('#u_url').val();
        var comment = $('#u_comment').val();
        $.ajax({
            url: "{:url('admin/Company/updateC')}",
            type: 'post',
            dataType: 'json',
            data: {id: id,name: name,addr: addr,charge_name: charge_name,tel: tel,url: url,comment: comment},
            success:function(data){
                console.log(data);
                if(data.code==0){
                    layer.msg(data.msg, {
                        icon: 2,
                        time: 2000
                    })
                }else{
                    var a = $('#company-tab .active');
                    var x = a.children('a').attr('href');
                    $.cookie('company',x);
                    $('#detail_C').modal('hide');
                    $('#updateC').modal('hide');
                    layer.msg(data.msg, {
                        icon: 1,
                        time: 1000
                    },function(){
                        location.reload();
                    })
                }
            }
        });
    }
    //公司删除
    function delC(){
        var company_id = $('#company').val();
        var info = $('#company_name').val();
        var name = '';
        var url = "{:url('admin/Company/del')}?id="+company_id;
        delcfm(url,info,name);
    }
    //添加地块
    function addL(id){
        var upper = $('#a_upper').val();
        var company_id = '';
        var park_id = '';
        if(upper!=0){
            company_id = upper;
        }else{
            park_id = id;
        }
        var name = $('#a_land_name').val();
        var acreage = $('#a_land_acreage').val();
        if(isNaN(acreage)){
            layer.msg('地块面积只能为数字！', {
                icon: 7,
                time: 2000
            });
            return;
        }
        var charge_name = $('#a_land_charge_name').val();
        var tel = $('#a_land_tel').val();
        var comment = $('#a_land_comment').val();
       
        $.ajax({
            url: "{:url('admin/Land/addL')}",
            type: 'post',
            dataType: 'json',
            data: {name: name,acreage:acreage,park_id: park_id,company_id: company_id,charge_name: charge_name,tel: tel,comment: comment},
            success:function(data){
                console.log(data);
                if(data.code==0){
                    layer.msg(data.msg, {
                        icon: 2,
                        time: 2000
                    })
                }else{
                    var a = $('#company-tab .active');
                    var x = a.children('a').attr('href');
                    $.cookie('company',x);
                    $('#addL').modal('hide');
                    layer.msg(data.msg, {
                        icon: 1,
                        time: 2000
                    },function(){
                        location.reload();
                    })
                }
            }
        });
    }
    //更新地块
    function editL(id){
        $('#land_id').val(id);
        //取出需要更新的地块的原数据
        $.ajax({
            url: "{:url('admin/Land/getLandInfo')}",
            type: 'post',
            dataType: 'json',
            data: {id: id},
            success:function(data){
                $('#u_land_name').val(data.name);
                $('#u_land_acreage').val(data.acreage);
                $('#u_land_charge_name').val(data.charge_name);
                $('#u_land_tel').val(data.tel);
                $('#u_land_comment').val(data.comment);
                if(data.park_id!=0){
                    $('#u_upper').val(0);
                }else{
                    $('#u_upper').val(data.company_id);
                }
            }
        });

        $('#updateL').modal('show');
    }
    function updateL(id){
        var upper = $('#u_upper').val();
        var company_id = '';
        var park_id = '';
        if(upper!=0){
            company_id = upper;
        }else{
            park_id = id;
        }
        var land_id = $('#land_id').val();
        var name = $('#u_land_name').val();
        var acreage = $('#u_land_acreage').val();
        if(isNaN(acreage)){
            layer.msg('地块面积只能为数字！', {
                icon: 7,
                time: 2000
            });
            return;
        }
        var tel = $('#u_land_tel').val();
        var charge_name = $('#u_land_charge_name').val();
        var comment = $('#u_land_comment').val();
        $.ajax({
            url: "{:url('admin/Land/updateL')}",
            type: 'post',
            dataType: 'json',
            data: {id: land_id,name: name,acreage:acreage,park_id: park_id,company_id: company_id,charge_name: charge_name,tel: tel,comment: comment},
            success:function(data){
                console.log(data);
                if(data.code==0){
                    layer.msg(data.msg, {
                        icon: 2,
                        time: 2000
                    })
                }else{
                    var a = $('#company-tab .active');
                    var x = a.children('a').attr('href');
                    $.cookie('company',x);
                    $('#updateL').modal('hide');
                    layer.msg(data.msg, {
                        icon: 1,
                        time: 1000
                    },function(){
                        location.reload();
                    })
                }
            }
        });
    }
    //地块详情
    function detail_L(id){
        $.ajax({
            url: "{:url('admin/Land/landDetail')}",
            type: 'post',
            dataType: 'json',
            data: {id: id},
            success:function(data){
                var tr = "<tr> <th>地块名称</th> <td  width='350'>"+data.name+"</td></tr> <tr> <th>地块编号</th> <td>"+data.code+"</td> </tr> <tr> <th>上级部门</th> <td>"+data.upper+"</td> </tr> <tr> <th>地块面积</th> <td>"+data.acreage+"(亩)</td> </tr> <tr> <th>负责人</th> <td>"+data.charge_name+"</td> </tr> <tr> <th>手机号码</th> <td>"+data.tel+"</td> </tr> <tr> <th>地块简介</th> <td>"+data.comment+"</td> </tr>";
                $('#details').html(tr);
            }
        });
        $('#detail_L').modal('show');
    }
    //添加传感器
    function addE(land_id,land_name){
        $('#a_upper_land_id').val(land_id);
        $('#a_upper_land_name').val(land_name);
        $('#a_camera_id option:eq(0)').text('--请选择监控设备(可不选)--');
        $.ajax({
            url: "{:url('admin/Equip/getMonitor')}",
            type: 'post',
            dataType: 'json',
            data: {land_id: land_id},
            success:function(data){
                if(data == ''){
                    $('#a_camera_id option:gt(0)').remove();
                    $('#a_camera_id option:eq(0)').text('--该地块下无监控信息--');
                }else {
                    var opt = '';
                    $.each(data, function (k, v) {
                        opt += '<option value="' + v.id + '">' + v.name + '</option>';
                    });
                    $('#a_camera_id option:gt(0)').remove();
                    $('#a_camera_id').append(opt);
                }
            }
        });
        $('#addE').modal('show');
    }
    function saveE(){
        var land_id = $('#a_upper_land_id').val();
        var equiptype_id = $('#a_equiptype').val();
        var name = $('#a_equip_name').val();
        var camera_id = $('#a_camera_id').val();
        $.ajax({
            url: "{:url('admin/Equip/addE')}",
            type: 'post',
            dataType: 'json',
            data: {land_id: land_id,equiptype_id: equiptype_id,name: name,camera_id: camera_id},
            success:function(data){
                console.log(data);
                if(data.code==0){
                    layer.msg(data.msg, {
                        icon: 2,
                        time: 2000
                    })
                }else{
                    var a = $('#company-tab .active');
                    var x = a.children('a').attr('href');
                    $.cookie('company',x);
                    $('#addE').modal('hide');
                    layer.msg(data.msg, {
                        icon: 1,
                        time: 1000
                    },function(){
                        location.reload();
                    })
                }
            }
        });
    }
    //更新传感器
    function editE(id,name){
        $('#e_id').val(id);
        $('#u_upper_land_name').val(name);
        $('#u_camera_id option:eq(0)').text('--请选择监控设备(可不选)--');
        //取出需要更新的传感器的原数据
        $.ajax({
            url: "{:url('admin/Equip/getEquipInfo')}",
            type: 'post',
            dataType: 'json',
            data: {id: id},
            success:function(data){
                $('#u_equiptype').val(data[0].equiptype_id);
                $('#u_equip_name').val(data[0].name);
                if(data[1] == ''){
                    $('#u_camera_id option:gt(0)').remove();
                    $('#u_camera_id option:eq(0)').text('--该地块下无监控信息--');
                }else{
                    var opt = '';
                    $.each(data[1],function(k,v){
                        opt += '<option value="'+ v.id+'">'+ v.name+'</option>';
                    });
                    $('#u_camera_id option:gt(0)').remove();
                    $('#u_camera_id').append(opt);
                }
                $('#u_camera_id').val(data[0].camera_id);
            }
        });

        $('#updateE').modal('show');
    }
    function updateE(){
        var id =  $('#e_id').val();
        var equiptype_id = $('#u_equiptype').val();
        var name = $('#u_equip_name').val();
        var camera_id = $('#u_camera_id').val();
        $.ajax({
            url: "{:url('admin/Equip/updateE')}",
            type: 'post',
            dataType: 'json',
            data: {id: id,name: name,equiptype_id: equiptype_id,camera_id: camera_id},
            success:function(data){
                console.log(data);
                if(data.code==0){
                    layer.msg(data.msg, {
                        icon: 2,
                        time: 2000
                    })
                }else{
                    var a = $('#company-tab .active');
                    var x = a.children('a').attr('href');
                    $.cookie('company',x);
                    $('#updateE').modal('hide');
                    layer.msg(data.msg, {
                        icon: 1,
                        time: 1000
                    },function(){
                        location.reload();
                    })
                }
            }
        });
    }
    //删除提示框
    function delcfm(url,info,name) {
        $('#url').val(url);//给会话中的隐藏属性URL赋值
        if(name==''){
            $('#detail_C').modal('hide');
        }
        $('#delcfmModel').modal();
        var text = '确定删除《'+info+'》'+name+'吗？';
        $('#tishi').text(text);
    }
    function urlSubmit(){
        var url=$.trim($("#url").val());//获取会话中的隐藏属性URL
        //window.location.href=url;
        $.ajax({
            url: url,
            type: 'get',
            success:function(data){
                console.log(data);
                if(data.code==0){
                    layer.msg(data.msg, {
                        icon: 2,
                        time: 2000
                    })
                }else{
                    var a = $('#company-tab .active');
                    var x = a.children('a').attr('href');
                    $.cookie('company',x);
                    layer.msg(data.msg, {
                        icon: 1,
                        time: 1000
                    },function(){
                        location.reload();
                    })
                }
            }
        });
    }
    //表单重置
    /* function reset(){
     $("input[name='res']").click();
     }*/
    $(function () { $('#addC').on('hide.bs.modal', function () {
        $("input[name='res']").click();
    })
    });
    $(function () { $('#addL').on('hide.bs.modal', function () {
        $("input[name='res']").click();
    })
    });
    $(function () { $('#addE').on('hide.bs.modal', function () {
        $("input[name='res']").click();
    })
    });


    //fileinput设置
    //添加公司图片
    $("#a_image").fileinput({
        uploadUrl: "{:url('admin/Company/uploadImg')}",
        language: 'zh',
        allowedFileExtensions : ['jpg', 'png','gif'],
        showCaption: true,//是否显示标题//接收的文件后缀
        showUpload: false,//是否显示上传按钮
        showRemove : false,
        showUploadedThumbs:false,
        //showPreview:true,
        uploadAsync: true,
        browseClass : 'btn btn-success',
        browseIcon : '<i class="glyphicon glyphicon-camera"></i> ',

    }).on("filebatchselected", function(event, files) {
        // trigger upload method immediately after files are selected
        $("#a_image").fileinput("upload");
        $(".file-preview ").show();
    }).on('fileuploaded', function(event, data) {
        var arr_data = data.response;
        if(arr_data)
        {
            $('#a_url').val(arr_data.filename);
        }
    });
    $(".file-preview ").hide();
    //编辑公司图片
    $("#u_image").fileinput({
        uploadUrl: "{:url('admin/Company/uploadImg')}",
        language: 'zh',
        allowedFileExtensions : ['jpg', 'png','gif'],
        showCaption: true,//是否显示标题//接收的文件后缀
        showUpload: false,//是否显示上传按钮
        showRemove : false,
        showPreview:false,
        uploadAsync: true,
        browseClass : 'btn btn-success',
        browseIcon : '<i class="glyphicon glyphicon-camera"></i> ',

    }).on("filebatchselected", function(event, files) {
        // trigger upload method immediately after files are selected
        $("#u_image").fileinput("upload");
        //$(".file-preview ").show();
    }).on('fileuploaded', function(event, data) {
        var arr_data = data.response;
        if(arr_data)
        {
            $('#u_url').val(arr_data.filename);
            $('#img').attr('src',arr_data.filename);
        }
    });

//传感器状态按钮
   $("[name='my-checkbox']").bootstrapSwitch({
        onText:"启用",
        offText:"禁用",
        onColor:"success",
        offColor:"danger",
        size:"small",
        onSwitchChange:function(event,state){
            if(state==true){
                var id = $(this).val();
                var status = 1;
                $.ajax({
                    url: "{:url('admin/Equip/changeStatus')}",
                    type: 'post',
                    dataType: 'json',
                    data: {id: id,status: status},
                    success:function(data){
                        console.log(data);
                        if(data.code==0){
                            layer.msg(data.msg, {
                                icon: 2,
                                time: 2000
                            },function(){
                                location.reload();
                            })
                        }else{
                            layer.msg(data.msg, {
                                icon: 1,
                                time: 2000
                            })
                        }
                    }
                });
            }else{
                var id = $(this).val();
                var status = 0;
                $.ajax({
                    url: "{:url('admin/Equip/changeStatus')}",
                    type: 'post',
                    dataType: 'json',
                    data: {id: id,status: status},
                    success:function(data){
                        console.log(data);
                        if(data.code==0){
                            layer.msg(data.msg, {
                                icon: 2,
                                time: 2000
                            },function(){
                                location.reload();
                            })
                        }else{
                            layer.msg(data.msg, {
                                icon: 1,
                                time: 2000
                            })
                        }
                    }
                });
            }
        }
    });

//获取提示数据
    function equipData(obj,name){
        layer.tips("<span style='font-size: 15px;padding: 5px'>"+name+"</span>", obj, {
            tips: [1, '#8bb57d']
        });
    }

</script>
{/block}
